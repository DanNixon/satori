<!DOCTYPE html>
<html>
  <head>
    <title>Video Player</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background-color: #1a1a1a;
        color: #e0e0e0;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      
      .container {
        display: flex;
        flex-direction: column;
        height: 100%;
        max-width: 100%;
      }
      
      .controls-panel {
        background-color: #2a2a2a;
        padding: 15px;
        border-bottom: 1px solid #3a3a3a;
        flex-shrink: 0;
      }
      
      .controls-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #fff;
      }
      
      .filter-group {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        align-items: center;
      }
      
      .filter-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
        min-width: 200px;
      }
      
      .timezone-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
        min-width: 200px;
      }
      
      .timezone-item label {
        font-size: 14px;
        font-weight: 500;
        color: #e0e0e0;
      }
      
      select.timezone-select {
        padding: 8px 12px;
        font-size: 14px;
        background-color: #3a3a3a;
        color: #e0e0e0;
        border: 1px solid #4a4a4a;
        border-radius: 4px;
        width: 100%;
        max-width: 250px;
        cursor: pointer;
      }
      
      select.timezone-select:focus {
        outline: none;
        border-color: #5a8dee;
      }
      
      .filter-header {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .filter-header input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }
      
      .filter-header label {
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        user-select: none;
      }
      
      input[type="text"].datetime-input {
        padding: 8px 12px;
        font-size: 14px;
        background-color: #3a3a3a;
        color: #e0e0e0;
        border: 1px solid #4a4a4a;
        border-radius: 4px;
        width: 100%;
        max-width: 250px;
        cursor: pointer;
      }
      
      input[type="text"].datetime-input:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      
      input[type="text"].datetime-input:focus {
        outline: none;
        border-color: #5a8dee;
      }
      
      /* Flatpickr custom styling */
      .flatpickr-calendar {
        background-color: #2a2a2a;
        border: 1px solid #4a4a4a;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      }
      
      .flatpickr-months {
        background-color: #3a3a3a;
      }
      
      .flatpickr-current-month {
        color: #e0e0e0;
      }
      
      .flatpickr-day {
        color: #e0e0e0;
      }
      
      .flatpickr-day.selected {
        background-color: #5a8dee;
        border-color: #5a8dee;
      }
      
      .flatpickr-day:hover {
        background-color: #4a4a4a;
      }
      
      .flatpickr-time input {
        background-color: #3a3a3a;
        color: #e0e0e0;
        border: 1px solid #4a4a4a;
      }
      
      .flatpickr-time input:focus {
        border-color: #5a8dee;
      }
      
      .video-container {
        flex: 1;
        position: relative;
        background-color: #000;
        overflow: hidden;
      }
      
      .video-container video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
      
      /* Responsive layout for mobile */
      @media (max-width: 768px) {
        .controls-panel {
          padding: 12px;
        }
        
        .controls-title {
          font-size: 16px;
          margin-bottom: 12px;
        }
        
        .filter-group {
          gap: 15px;
        }
        
        .filter-item {
          min-width: 100%;
        }
        
        .timezone-item {
          min-width: 100%;
        }
        
        input[type="text"].datetime-input {
          max-width: 100%;
        }
        
        select.timezone-select {
          max-width: 100%;
        }
      }
    </style>
  </head>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <body>
    <div class="container">
      <div class="controls-panel">
        <div class="controls-title">Time Filter</div>
        <div class="filter-group">
          <div class="filter-item">
            <div class="filter-header">
              <input type="checkbox" id="enableStart" checked>
              <label for="enableStart">Start Time</label>
            </div>
            <input type="text" class="datetime-input" id="startTime" placeholder="Select date and time" readonly>
          </div>
          <div class="filter-item">
            <div class="filter-header">
              <input type="checkbox" id="enableEnd">
              <label for="enableEnd">End Time</label>
            </div>
            <input type="text" class="datetime-input" id="endTime" placeholder="Select date and time" readonly>
          </div>
          <div class="timezone-item">
            <label for="timezoneSelect">Time Zone</label>
            <select id="timezoneSelect" class="timezone-select">
              <!-- Populated by JavaScript -->
            </select>
          </div>
        </div>
      </div>
      <div class="video-container">
        <video id="video" controls="true"></video>
      </div>
    </div>
    <script>
      // Parse URL parameters to get initial values
      const urlParams = new URLSearchParams(window.location.search);
      const initialSince = urlParams.get('since');
      const initialUntil = urlParams.get('until');
      
      // Get DOM elements
      const startTimeInput = document.getElementById('startTime');
      const endTimeInput = document.getElementById('endTime');
      const enableStartCheckbox = document.getElementById('enableStart');
      const enableEndCheckbox = document.getElementById('enableEnd');
      const timezoneSelect = document.getElementById('timezoneSelect');
      const video = document.getElementById('video');
      
      // Get browser's timezone offset in minutes
      const browserTimezoneOffset = -new Date().getTimezoneOffset();
      
      // Populate timezone selector with common timezones
      const timezones = [
        { offset: -720, label: 'UTC-12:00' },
        { offset: -660, label: 'UTC-11:00' },
        { offset: -600, label: 'UTC-10:00' },
        { offset: -540, label: 'UTC-09:00' },
        { offset: -480, label: 'UTC-08:00' },
        { offset: -420, label: 'UTC-07:00' },
        { offset: -360, label: 'UTC-06:00' },
        { offset: -300, label: 'UTC-05:00' },
        { offset: -240, label: 'UTC-04:00' },
        { offset: -180, label: 'UTC-03:00' },
        { offset: -120, label: 'UTC-02:00' },
        { offset: -60, label: 'UTC-01:00' },
        { offset: 0, label: 'UTC+00:00' },
        { offset: 60, label: 'UTC+01:00' },
        { offset: 120, label: 'UTC+02:00' },
        { offset: 180, label: 'UTC+03:00' },
        { offset: 240, label: 'UTC+04:00' },
        { offset: 300, label: 'UTC+05:00' },
        { offset: 330, label: 'UTC+05:30' },
        { offset: 360, label: 'UTC+06:00' },
        { offset: 420, label: 'UTC+07:00' },
        { offset: 480, label: 'UTC+08:00' },
        { offset: 540, label: 'UTC+09:00' },
        { offset: 600, label: 'UTC+10:00' },
        { offset: 660, label: 'UTC+11:00' },
        { offset: 720, label: 'UTC+12:00' },
        { offset: 780, label: 'UTC+13:00' },
      ];
      
      // Find and set browser's timezone as default
      let selectedTimezoneOffset = browserTimezoneOffset;
      timezones.forEach(tz => {
        const option = document.createElement('option');
        option.value = tz.offset;
        option.textContent = tz.label;
        if (tz.offset === browserTimezoneOffset) {
          option.textContent += ' (Browser)';
          option.selected = true;
        }
        timezoneSelect.appendChild(option);
      });
      
      // Function to convert RFC3339 to Date object
      function rfc3339ToDate(rfc3339) {
        if (!rfc3339) return null;
        const date = new Date(rfc3339);
        return isNaN(date.getTime()) ? null : date;
      }
      
      // Function to format offset as RFC3339 timezone string
      function formatTimezoneOffset(offsetMinutes) {
        const sign = offsetMinutes >= 0 ? '+' : '-';
        const absOffset = Math.abs(offsetMinutes);
        const hours = Math.floor(absOffset / 60);
        const minutes = absOffset % 60;
        return `${sign}${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
      }
      
      // Function to convert Date to RFC3339 format with specified timezone offset
      function dateToRfc3339(date, timezoneOffsetMinutes) {
        if (!date) return '';
        
        // Get UTC timestamp
        const utcTime = date.getTime();
        
        // Apply timezone offset to get local time
        const localTime = new Date(utcTime + (timezoneOffsetMinutes * 60000));
        
        // Format as RFC3339 with timezone offset
        const year = localTime.getUTCFullYear();
        const month = String(localTime.getUTCMonth() + 1).padStart(2, '0');
        const day = String(localTime.getUTCDate()).padStart(2, '0');
        const hours = String(localTime.getUTCHours()).padStart(2, '0');
        const minutes = String(localTime.getUTCMinutes()).padStart(2, '0');
        const seconds = String(localTime.getUTCSeconds()).padStart(2, '0');
        
        const tzOffset = formatTimezoneOffset(timezoneOffsetMinutes);
        
        return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}${tzOffset}`;
      }
      
      // Initialize Flatpickr for start time
      const startTimePicker = flatpickr(startTimeInput, {
        enableTime: true,
        enableSeconds: true,
        dateFormat: "Y-m-d H:i:S",
        time_24hr: true,
        defaultDate: initialSince ? rfc3339ToDate(initialSince) : null,
        onChange: function(selectedDates, dateStr, instance) {
          if (enableStartCheckbox.checked && selectedDates.length > 0) {
            reloadVideo();
          }
        }
      });
      
      // Initialize Flatpickr for end time
      const endTimePicker = flatpickr(endTimeInput, {
        enableTime: true,
        enableSeconds: true,
        dateFormat: "Y-m-d H:i:S",
        time_24hr: true,
        defaultDate: initialUntil ? rfc3339ToDate(initialUntil) : null,
        onChange: function(selectedDates, dateStr, instance) {
          if (enableEndCheckbox.checked && selectedDates.length > 0) {
            reloadVideo();
          }
        }
      });
      
      // Initialize checkbox states
      if (initialSince) {
        enableStartCheckbox.checked = true;
      } else {
        enableStartCheckbox.checked = false;
        startTimeInput.disabled = true;
      }
      
      if (initialUntil) {
        enableEndCheckbox.checked = true;
      } else {
        enableEndCheckbox.checked = false;
        endTimeInput.disabled = true;
      }
      
      // Function to reload video with current filter settings
      function reloadVideo() {
        const params = new URLSearchParams();
        const tzOffset = parseInt(timezoneSelect.value);
        
        if (enableStartCheckbox.checked && startTimePicker.selectedDates.length > 0) {
          params.set('since', dateToRfc3339(startTimePicker.selectedDates[0], tzOffset));
        }
        
        if (enableEndCheckbox.checked && endTimePicker.selectedDates.length > 0) {
          params.set('until', dateToRfc3339(endTimePicker.selectedDates[0], tzOffset));
        }
        
        // Update URL without page reload
        const newUrl = params.toString() ? `?${params.toString()}` : window.location.pathname;
        window.history.pushState({}, '', newUrl);
        
        // Build HLS URL with parameters
        const hlsParams = new URLSearchParams();
        if (enableStartCheckbox.checked && startTimePicker.selectedDates.length > 0) {
          hlsParams.set('since', dateToRfc3339(startTimePicker.selectedDates[0], tzOffset));
        }
        if (enableEndCheckbox.checked && endTimePicker.selectedDates.length > 0) {
          hlsParams.set('until', dateToRfc3339(endTimePicker.selectedDates[0], tzOffset));
        }
        
        const videoSrc = hlsParams.toString() ? `./hls?${hlsParams.toString()}` : './hls';
        
        // Reload video with new source
        if (window.hls) {
          window.hls.destroy();
        }
        
        if (Hls.isSupported()) {
          window.hls = new Hls({startPosition: 0, worker: true});
          window.hls.loadSource(videoSrc);
          window.hls.attachMedia(video);
          window.hls.on(Hls.Events.MANIFEST_PARSED, function() {
            video.play();
          });
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
          video.src = videoSrc;
          video.addEventListener('loadedmetadata', function() {
            video.play();
          });
        }
      }
      
      // Enable/disable start time input
      enableStartCheckbox.addEventListener('change', function() {
        startTimeInput.disabled = !this.checked;
        if (this.checked) {
          startTimePicker.open();
        }
        reloadVideo();
      });
      
      // Enable/disable end time input
      enableEndCheckbox.addEventListener('change', function() {
        endTimeInput.disabled = !this.checked;
        if (this.checked) {
          endTimePicker.open();
        }
        reloadVideo();
      });
      
      // Reload video when timezone changes
      timezoneSelect.addEventListener('change', function() {
        reloadVideo();
      });
      
      // Initial video load
      reloadVideo();
    </script>
  </body>
</html>
